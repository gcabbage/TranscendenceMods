<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<!-- Mission: Liberate Raisu station =======================================

	EXTRA DATA

	stationID:				Occupied station (Raisu)
	targetID:				ID of ship to destroy (Arco Vaughn)
	raidersSummoned:		Number of raiders summoned to station
	arcoDestroyed:			True when Arco is dead

	======================================================================== -->

	<MissionType UNID="&msRaisuStation;"
			name=				"Liberate Raisu station"
			attributes=			"commonwealth, special"

			level=				"1"

			priority=			"10"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(arcoVaughn (sysFindObject gSource "sN +arcoVaughn;"))
					(stationObj (sysFindObject Nil "TAN +unid:&stRaisuStation;;"))
					)
					(switch
						(not arcoVaughn)
							(msnDestroy gSource)

						(not stationObj)
							(msnDestroy gSource)

						(block Nil
							(msnSetData gSource 'stationID (objGetID stationObj))
							(msnRegisterForEvents gSource stationObj)

							(msnSetData gSource 'targetID (objGetID arcoVaughn))
							(msnRegisterForEvents gSource arcoVaughn)

							; Updates
							(msnAddRecurringTimerEvent gSource 451 'OnUpdate)
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (theItem launcherItem missileTypes bestType)
					; Give the player some appropriate missiles
					(switch
						;	If we don't have a launcher, give a missile rack
						(not (setq launcherItem (@ (objGetItems gPlayerShip "lI -Disposable;") 0)))
							(setq theItem (itmCreate &itDM1500MissileRack; 1))

						;	Find all compatible missiles for this launcher
						(not (setq missileTypes (itmGetTypes (cat "M +launchedBy:" (itmGetType launcherItem) ";"))))
							(setq theItem (itmCreate &itDM1500MissileRack; 1))

						;	Find a tracking missile of level 3 or less.
						(setq bestType
								(map missileTypes (list 'reduceMax 'original 'excludeNil) theType
									(if (and (itmGetProperty theType 'tracking)
											(leq (itmGetLevel theType) 3)
											)
										(itmGetLevel theType)
										)
									)
								)
							(setq theItem (itmCreate bestType (random 32 48)))

						;	Otherwise, any missile of level 5 or less.
						(setq bestType
								(map missileTypes (list 'reduceMax 'original 'excludeNil) theType
									(if (leq (itmGetLevel theType) 5)
										(itmGetLevel theType)
										)
									)
								)
							(setq theItem (itmCreate bestType (random 32 48)))

						;	Otherwise, default to a missile rack
						(setq theItem (itmCreate &itDM1500MissileRack; 1))
						)
					(objAddItem gPlayerShip theItem)
					(msnSetData gSource 'theItem theItem)
					)
			</OnAccepted>

			<OnSetPlayerTarget>
				(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)))
			</OnSetPlayerTarget>

			<OnObjDestroyed>
				(switch
					(= (objGetID aObjDestroyed) (msnGetData gSource 'stationID))
						(block Nil
							; Set achievements here as OnCompleted is not called if the player has not accepted the mission
							(if (and gPlayerShip (= aOrderGiver gPlayerShip))
								(msnFireEvent gSource 'SetAchievement 'AchievementBetrayal)
								(msnFireEvent gSource 'SetAchievement 'AchievementFailure)
								)
							(msnFailure gSource)
							)

					(= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(block Nil
							(msnSetData gSource 'arcoDestroyed True)
							(msnSuccess gSource)
							)
					)
			</OnObjDestroyed>

			<OnUpdate>
				(block (
					(stationObj (objGetObjByID (msnGetData gSource 'stationID)))
					)
					(switch
						; If Arco vaughn is destroyed, then some commonwealth ships show up
						(and (msnGetData gSource 'arcoDestroyed)
							(ls (count (staGetSubordinates stationObj)) 3))
							(block (theShip)
								(setq theShip
									(sysCreateShip (random '(&scEI100; &scEI100; &scSapphireYacht; &scBorer;))
										(sysFindObject stationObj "GN -uncharted;")
										&svCommonwealth;
										)
									)
								(shpOrder theShip 'dock stationObj)
								(shpOrder theShip 'gateOnThreat)
								(objAddSubordinate stationObj theShip)
								)

						; If there are no raiders around, then summon some more
						(and (not (msnGetData gSource 'arcoDestroyed))
							(leq (random 1 100) 20)
							(not (sysFindObject stationObj "s +centauriWarlords; N:150")))

							(if (gr (msnGetData gSource 'raidersSummoned) 20)

								; If we've already summoned lots of raiders, then send Arco Vaughn
								(block (arcoVaughn)
									(setq arcoVaughn (sysFindObject stationObj "sN +arcoVaughn;"))
									(if arcoVaughn
										(objFireEvent arcoVaughn "OrderKillPlayer")
										)
									)

								; Otherwise, summon more raiders
								(block (newShips)
									(setq newShips (random 3 4))
									(msnIncData gSource 'raidersSummoned newShips)
									(for i 1 newShips
										(block (theShip)
											(setq theShip
												(sysCreateShip &scCentauriRaider;
													(sysFindObject stationObj "GN -uncharted;")
													&svCentauriWarlords;
													)
												)
											(shpOrder theShip 'patrol stationObj 10)
											)
										)
									)
								)
						)
					)
			</OnUpdate>

			<OnCompleted>
				(if (= aReason 'success)
					(msnFireEvent gSource 'SetAchievement 'AchievementSuccess)
					)
			</OnCompleted>

			<SetAchievement>
				; Set achievement
				(typSetData &msRaisuStation; 'achievements
					(list
						(list (msnTranslate gSource gData)
							Nil
							"achievements &amp; regrets"
							)
						)
					)
			</SetAchievement>

			<OnReward>
			</OnReward>

			<OnGlobalSystemStarted>
				(block (raisuObj)
					(switch
						; Only create in Starton Eridani
						(!= (sysGetNode) 'SE)
							Nil

						; Only create one
						(msnFind "* +unid:&msRaisuStation;;")
							Nil

						(not (setq raisuObj (sysFindObject Nil "TAN +unid:&stRaisuStation;;")))
							Nil

						(msnCreate &msRaisuStation; raisuObj)
						)
					)
			</OnGlobalSystemStarted>

			<GetGlobalAchievements>
				(typGetData &msRaisuStation; 'achievements)
			</GetGlobalAchievements>

			<GetGlobalDockScreen>
				(block (missionObj)
					(switch
						(setq missionObj (@
								(filter (msnFind gSource "* +unid:&msRaisuStation;;") theMission
									(and
										(not (msnGetProperty theMission 'isCompleted))
										(= gSource (objGetObjByID (msnGetData theMission 'stationID)))
										)
									)
								0))
							(list &dsRaisuStation; { missionObj: missionObj } 10)

						; Otherwise, nothing
						Nil
						)
					)
			</GetGlobalDockScreen>

			<GetRumors>
				(switch
					(!= (msnGetProperty gSource 'nodeID) (sysGetNode))
						Nil

					(= (objGetType (@ gData 'stationObj)) &stRaisuStation;)
						Nil

					(msnGetProperty gSource 'isSuccess)
						(switch
							(= (objGetType (@ gData 'stationObj)) &stCommonwealthSlums;)
								(msfSimpleRumors (msnTranslate gSource 'RumorsSuccessCommonwealthSlums))
							)

					(msnGetProperty gSource 'isFailure)
						(switch
							(= (objGetType (@ gData 'stationObj)) &stCommonwealthSlums;)
								(msfSimpleRumors (msnTranslate gSource 'RumorsFailureCommonwealthSlums))
							)

					(= (objGetType (@ gData 'stationObj)) &stContainerHabitat;)
						(msfSimpleRumors (msnTranslate gSource 'RumorsContainerHabitat) 2)

					(= (objGetType (@ gData 'stationObj)) &stCommonwealthSlums;)
						(msfSimpleRumors (msnTranslate gSource 'RumorsCommonwealthSlums) 2)

					Nil
					)
			</GetRumors>
		</Events>

		<Language>
			<Text id="Name">
				"Kill Arco Vaughn"
			</Text>
			<Text id="Summary">
				(cat
					"Raisu station has been taken over by Centauri warlords. Your mission is to hunt down "
					"and kill their leader&#x97;Arco Vaughn.\n\n"
					"System: " (sysGetName) "\n"
					"Payment: " (fmtCurrency 'credit (msnGetData gSource 'reward))
					)
			</Text>
			<Text id="Intro">
				(cat
					"The station master stands at her console. She runs towards you tearfully:\n\n"
					"\"Is it true? Have you fought the Centauri warlords? It's been so long since anyone stood "
					"up to them. Will you finish what you've begun? If you don't kill the rest of them now, "
					"we will be the ones who suffer. Arco Vaughn is the key. Kill him and the rest will leave us alone.\""
					)
			</Text>
			<Text id="Briefing">
				(cat
					"\"I can help you; I'm not afraid anymore. Arco Vaughn lives deep in the outer belt&#x97;"
					"I can give you the coordinates. Kill him and we will all be free. Will you help us?\""
					)
			</Text>
			<Text id="AcceptReply">
				(block (
					(theItem (msnGetData gSource 'theItem))
					(single (= (itmGetCount theItem) 1))
					)
					(cat
						"\"You will need all the power you can to kill him. I have " (if single "a" "some")
						" hidden " (itmGetName theItem (if single 0x00 0x02)) " that the warlords never found. "
						(if single "It" "They") " belonged to my husband...many years ago. Take "
						(if single "it" "them") " and good luck!\""
						"\n\nShe hugs you quickly and runs off."
						)
					)
			</Text>
			<Text id="DeclineReply">
				(cat
					"The station master stares at you in shock and then begins to weep.\n\n"
					"\"Why did you start this war if you won't finish it! You've doomed us all!\""
					)
			</Text>
			<Text id="InProgress">
				"The station master's console is empty. Everyone on the station is hiding in the central hub."
			</Text>
			<Text id="SuccessDebrief">
				(cat
					"The station master runs towards you; she puts her arms around you as the rest of the citizens come out of hiding.\n\n"
					"\"You did it! I never thought I would live to see it! You've freed us from the warlords!\"\n\n"
					(if (= (plyGetGenome gPlayer) 'humanMale)
						"She hugs you again and whispers her name in your ear."
						"She beams a smile and hugs you again."
						)
					)
			</Text>
			<Text id="SuccessMsg">
				"Mission complete!"
			</Text>

			<Text id="AchievementSuccess">
				"Liberated Raisu station"
			</Text>
			<Text id="AchievementFailure">
				"Allowed Raisu station to be destroyed"
			</Text>
			<Text id="AchievementBetrayal">
				"Destroyed Raisu station"
			</Text>

			<Text id="RumorsContainerHabitat">
				(list
					"\"Watch out for Arco Vaughn. He is the most dangerous Centauri warlord; his heavy raider is protected against lasers and recoilless cannons. Avoid him if you want to live.\""
					"\"Arco Vaughn flies an enhanced heavy raider. His armor is protected against normal weapons; you'll need missiles to kill him.\""
					"\"Raisu Station is in trouble. The Centauri warlords have taken it over; don't go there unless you are armed and ready.\""
					"\"If you want to find Arco Vaughn, go to Raisu Station. Talk to the station master there. She will help you.\""
					"\"The Centauri warlords have many bases among the outer asteroids of Eridani; but if you go there, watch out: Arco Vaughn is there too.\""
					)
			</Text>

			<Text id="RumorsCommonwealthSlums">
				(block (
					(stationObj (objGetObjByID (msnGetData gSource 'stationID)))
					)
					(list
						{
							desc: (cat
								"\"If you're looking for Arco Vaughn, go to Raisu station: the station master "
								"there will help you out. But first you gotta convince her that you're serious.\""
								)
							priority: 1
							code: (lambda () (objSetKnown stationObj))
							}

						{
							desc: (cat
								"\"If you need help against Arco Vaughn the station master at Raisu station will "
								"help you. But you'll have to prove that you're serious. Take out a few Centauri "
								"stations and you might convince her.\""
								)
							priority: 1
							code: (lambda () (objSetKnown stationObj))
							}
						"\"The warlords are annoying, but they don't mean much. The only one that bothers me is Arco Vaughn. He's trouble. Someone ought to air him out before things get out of hand, you know?\""
						"\"It's sad about Raisu station, isn't it? If a corporate fuel station got taken over by Centauri warlords they'd have Admiral Decker himself leading the rescue. But no one cares about a poor, backwater station, I guess.\""
						)
					)
			</Text>

			<Text id="RumorsSuccessCommonwealthSlums">
				(list
					"\"Thank heavens that someone finally killed Arco Vaughn. Maybe now the warlords will leave us alone.\""
					"\"It's shame what Raisu station had to go through, isn't it? If a corporate station had been occupied by warlords, they'd have sent Admiral Decker himself to lead the rescue. But no one cares about a poor, backwater station, I guess.\""
					"\"I hear that Arco Vaughn is finally dead. No one will mourn him. I really feel for Erica and her team at Raisu\x97they went through hell.\""
					"\"We're all glad that Arco Vaughn is dead. I heard someone from Raisu station finally had enough and decided to chase him down.\""
					)
			</Text>

			<Text id="RumorsFailureCommonwealthSlums">
				(list
					"\"It's terrible what happened to Raisu station, isn't it? No one cared about a poor backwater station and they just let the Centauri warlords killed everyone.\""
					"\"I heard someone from Raisu station finally had enough and tried to kill Arco Vaughn, but he was too strong and now everyone on Raisu is dead.\""
					)
			</Text>
		</Language>
	</MissionType>

<!-- DOCK SCREENS -->

	<DockScreen UNID="&dsRaisuStation;"
			inherit=			"&dsDockScreenBase;"
			>
		<Panes>
			<Default>
				<OnPaneInit>
					(scrSetDescTranslate gScreen 'descWelcome)
				</OnPaneInit>
				<Actions>
					<Action id="actionMeetingHall" default="1">
						(block (
							(centauriStationsActive (count (sysFindObject gPlayerShip "TAE +centauriWarlords; +populated; -occupation; -uncharted;")))
							(centauriStationsDestroyed (count (sysFindObject gPlayerShip "TKE +centauriWarlords; +populated; -occupation; -uncharted;")))
							)
							(switch
								; If the player declined, then everyone is still in fear
								(msnGetProperty (scrGetData gScreen 'missionObj) 'isDeclined)
									(scrShowPane gScreen "MeetingHallHiding")

								; If there are Centauri raiders in range, then everyone is hiding
								(sysFindObject gSource "s +centauriWarlords; N:100;")
									(scrShowPane gScreen "MeetingHallHiding")

								; If less than three stations destroyed then station is still fearful
								(and (gr centauriStationsActive 0) (ls centauriStationsDestroyed 3))
									(scrShowPane gScreen "MeetingHallFearful")

								; Otherwise, see if we get a mission
								(rpgMissionAssignment {
									missionCriteria: "n +commonwealth;"
									noMissionTextID: 'descNoMissions
									maxPerStation: 1
									})
								)
							)
					</Action>

					<Action id="actionUndock" cancel="1">
						<Exit/>
					</Action>
				</Actions>
			</Default>

			<MeetingHallHiding>
				<OnPaneInit>
					(scrSetDescTranslate gScreen 'descHiding)
				</OnPaneInit>

				<Actions>
					<Action id="actionContinue" default="1" cancel="1">
						(scrShowPane gScreen "Default")
					</Action>
				</Actions>
			</MeetingHallHiding>

			<MeetingHallFearful>
				<OnPaneInit>
					(block (
						(centauriStationsDestroyed (count (sysFindObject gPlayerShip "TKE +centauriWarlords; +populated; -occupation; -uncharted;")))
						)
						(switch
							(= centauriStationsDestroyed 0)
								(scrSetDescTranslate gScreen 'descAfraid0)

							(= centauriStationsDestroyed 1)
								(scrSetDescTranslate gScreen 'descAfraid1)

							(scrSetDescTranslate gScreen 'descAfraid2)
							)
						)
				</OnPaneInit>

				<Actions>
					<Action id="actionContinue" default="1" cancel="1">
						(scrShowPane gScreen "Default")
					</Action>
				</Actions>
			</MeetingHallFearful>
		</Panes>

		<Language>
			<Text id="actionMeetingHall">"[M]eeting Hall"</Text>
			<Text id="descHiding">
				"The station master's console is empty. Everyone on the station is hiding in the central hub."
			</Text>
			<Text id="descAfraid0">
				(cat
					"The station master stands at her console. She turns her attention towards you:\n\n"
					"\"You'd better leave before the warlords return. If they see an armed ship here "
					"they will kill you; and we will be punished. Go now!\""
					)
			</Text>
			<Text id="descAfraid1">
				(cat
					"The station master stands at her console. She turns her attention towards you:\n\n"
					"\"The Centauri warlords are furious that you've blown up one of their stations! "
					"Do you really think you're strong enough to stand up to them?! "
					"Please leave before you get us all killed!\""
					)
			</Text>
			<Text id="descAfraid2">
				(cat
					"The station master stands at her console. She turns her attention towards you:\n\n"
					"\"Please leave! You know what will happen if you try to destroy more Centauri bases? "
					"You'll be killed and we'll be punished! And if Arco Vaughn sees you here, we're all dead!\""
					)
			</Text>
		</Language>
	</DockScreen>

</TranscendenceModule>
