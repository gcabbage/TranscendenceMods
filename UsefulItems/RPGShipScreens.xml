<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<!-- Player ship's cargo hold -->

	<DockScreen UNID="&dsCargoHold;"
			name=				"Ship's Cargo Hold"
			desc=				"Interior of Ship"
			inherit=			"&dsDockScreenBase;"
			nestedScreen=		"true"
			>

		<Display type="itemPicker"
				dataFrom=	"player"
				list=		"*U"
				>
		</Display>

		<Panes>
			<Default>
				<OnPaneInit>
					(block (thisItem desc maxCount)
						(if (scrGetData gScreen 'cursor)
							(block Nil
								(scrSetListCursor gScreen (scrGetData gScreen 'cursor))
								(scrSetData gScreen 'cursor Nil)
								)
							)

						(setq thisItem (scrGetItem gScreen))
						(setq maxCount (itmGetCount thisItem))

						(switch
							(= maxCount 0)
								(scrSetDescTranslate gScreen 'descCargoEmpty)
							
							(= maxCount 1)
								(scrSetDescTranslate gScreen 'descCargoItem {
									unitMass: (strMassString (itmGetMass thisItem))
									})
								
							(scrSetDescTranslate gScreen 'descCargoItems {
								unitMass: (strMassString (itmGetMass thisItem))
								count: maxCount
								totalMass: (strMassString (* (itmGetMass thisItem) maxCount))
								})
							)

						;	Remember some calculations for later
						
						(scrSetData gScreen 'maxCount maxCount)

						;	Enable/disable actions

						(scrEnableAction gScreen 'actionJettisonItem (gr maxCount 0))
						(scrEnableAction gScreen 'actionUse (or (itmMatches thisItem 'u) (itmHasAttribute thisItem 'Usable)))
						)
				</OnPaneInit>

				<Actions>
					<Action id="actionJettisonItem">
						(block (
							(maxCount (scrGetData gScreen 'maxCount))
							)
							(switch
								(gr maxCount 1)
									(scrShowPane gScreen "JettisonQuantity")

								(block (itemsToJettison)
									; Create cargo crate
									(if (not gDest)
										(setq gDest (sysCreateStation &stGenericCargoCrate; (sysVectorPolarOffset gPlayerShip 0 0)))
										)

									; Dump items
									(setq itemsToJettison (scrRemoveItem gScreen 1))
									(rpgJettisonItem gDest itemsToJettison)
									(scrShowPane gScreen "Default")
									)
								)
							)
					</Action>

					<Action id="actionUse" default="1">
						(block Nil
							(scrSetData gScreen 'cursor (scrGetListCursor gScreen))
							(scrShowScreen gScreen &dsRPGUseItem; {
								useItem: (scrGetItem gScreen)
								})
							)
					</Action>

					<Action id="actionDone" cancel="1">
						<Exit/>
					</Action>
				</Actions>
			</Default>

			<JettisonQuantity
					showCounter=	"true">

				<OnPaneInit>
					(block (
						(maxCount (scrGetData gScreen 'maxCount))
						)
						(scrSetDescTranslate gScreen 'descHowMany)
						(scrSetCounter gScreen maxCount)
						)
				</OnPaneInit>

				<Actions>
					<Action id="actionJettison" default="1">
						(block (
							(useCount (scrGetCounter gScreen))
							(maxCount (scrGetData gScreen 'maxCount))
							)
							
							(switch
								(= useCount 0)
									(scrShowPane gScreen "Default")

								(gr useCount maxCount)
									(scrSetCounter gScreen maxCount)

								(block (itemsToJettison)
									;	Create cargo crate
									(if (not gDest)
										(setq gDest (sysCreateStation &stGenericCargoCrate; (sysVectorPolarOffset gPlayerShip 0 0)))
										)

									;	Dump items
									(setq itemsToJettison (scrRemoveItem gScreen count))
									(rpgJettisonItem gDest itemsToJettison)
									(scrShowPane gScreen "Default")
									)
								)
							)
					</Action>

					<Action id="actionCancel" cancel="1">
						(scrShowPane gScreen "Default")
					</Action>
				</Actions>
			</JettisonQuantity>
		</Panes>

		<Language>
			<Text id="actionJettisonItem">[J]ettison this Item</Text>
			<Text id="actionJettison">[J]ettison</Text>
			<Text id="actionUse">[U]se this Item</Text>

			<Text id="descCargoEmpty">You are in your ship's cargo hold.</Text>
			<Text id="descCargoItem">Unit mass: %unitMass%</Text>
			<Text id="descCargoItems">Unit mass: %unitMass% (%count% at %totalMass%)</Text>
			<Text id="descHowMany">How many items do you wish to jettison?</Text>
		</Language>
	</DockScreen>

</TranscendenceModule>
