<?xml version="1.0" ?>
<!-- Corporate BioSec Missions
	msCorpBioSecInvestigate1	Intercept independent trader
	msCorpBioSecQuarantine		Intercept (friendly) freighter
	msCorpBioSecSupplies1		Collect medical supplies
	msCorpBioSecInvestigate2	Deliver ROM to medical station
	msCorpBioSecInvestigate3	Attack anarchist base
	msCorpBioSecInvestigate4	End Quarantine

	To do:
	*	Investigate1 - additional failure messages
	-->

<TranscendenceModule>

	<!-- Mission: Investigate 1 =================================================

	Investigate independent trader

	EXTRA DATA

	parentID:		Parent mission
	stationID:		objID of quarantined station
	stationName:	Name of quarantined station
	destID:			Destination of ship
	reward:			Reward (in credits) for completing mission
	targetID:		objID of ship to destroy
	wreckID:		objID of the ship wreck
	item1:			item to recover
	item2:			item to recover
	status:			One of:
		investigate:	Player must intercept target
		search:			Player must collect evidence from wreck
		foundItems:		Player has collected items

	======================================================================== -->

	<MissionType UNID="&msCorpBioSecInvestigate1;"
			name=				"Quarantine Investigation 1"
			attributes=			"corporate, corporatePrivateer, corpBioSec, special"
			priority=			"10"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<StaticData>
			<Encounter>
				(	Nil
					&stOutlawBase;
					&stOutlawBase2;
					&stOutlawBase2;
					&stOutlawHaven;
					&stOutlawHaven;
					)
			</Encounter>
		</StaticData>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					)
					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						(block Nil
							; Copy data from parent mission
							(msnSetData gSource 'parentID (objGetID aidMission))
							(msnSetData gSource 'stationID (msnGetData aidMission 'stationID))
							(msnSetData gSource 'stationName (msnGetData aidMission 'stationName))

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					(stationObj (objGetObjByID (msnGetData gSource 'stationID)))
					(enemyStations (sysFindObject stationObj "TAE +populated; +outlaws; -uncharted; N:600;"))
					baseObj targetObj email
					)

					; If we have a suitable outlaw station, then use it. Otherwise create a new one
					(setq baseObj
						(if enemyStations
							(random enemyStations)
							(sysCreateStation
								(@ (msnGetStaticData gSource 'Encounter) (sysGetLevel))
								(sysVectorRandom stationObj (random 360 600) 200 "t -asteroid;")
								)
							)
						)
					(msnSetData gSource 'baseID (objGetID baseObj))
					(msnRegisterForEvents gSource baseObj)

					; Create the freighter
					(setq targetObj (sysCreateShip &tbCorpBioSecInvestigate1Ship; baseObj &svIndependentTrader;))
					(shpCancelOrders targetObj)
					(shpOrder targetObj 'dock baseObj)
					(shpOrder targetObj 'gateOnThreat)
					(objSetProperty targetObj 'alwaysLeaveWreck True)

					(msnSetData gSource 'targetID (objGetID targetObj))
					(msnRegisterForEvents gSource targetObj)

					; Add items to recover
					(setq email (itmCreate &itNamedDataROM; 1))
					(setq email (itmSetData email "name" "Ship log"))
					(setq email (itmSetData email "desc" "This data ROM contains the black box data recordings from a ship."))
					(setq email (itmSetData email "corpBioSec" True))
					(objAddItem targetObj email)

					(msnSetData gSource 'item1 email)

					; Investigate
					(msnSetData gSource 'status 'investigate)
					(msnRegisterForEvents gSource gPlayerShip)
					)
			</OnAccepted>

			<OnSetPlayerTarget>
				(block (
					(status (msnGetData gSource 'status))
					)
					(switch
						(= status 'investigate)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)) 'attack)

						(= status 'search)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'wreckID)) 'dock)

						(objGetProperty (objGetObjByID (msnGetData gSource 'baseID)) 'abandoned)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetProperty gSource 'ownerID)) 'dock)

						(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'baseID)) 'attack)
						)
					)
			</OnSetPlayerTarget>

			<OnObjDocked>
				(switch
					; If the player has returned with the required items and destroyed targets the mission succeeds,
					(and (= aObjDocked gPlayerShip)
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						(objGetProperty (objGetObjByID (msnGetData gSource 'baseID)) 'abandoned)
						(objHasItem gPlayerShip (msnGetData gSource 'item1))
						(objHasItem gPlayerShip (msnGetData gSource 'item2))
						(msnGetProperty gSource 'isActive)
						)
						(block Nil
							; Remove the items from the player ship and complete mission
							(objRemoveItem gPlayerShip (msnGetData gSource 'item1))
							(objRemoveItem gPlayerShip (msnGetData gSource 'item2))
							(msnSuccess gSource)
							)

					; If the player has managed to lose the items then the mission is a failure
					(and (= aObjDocked gPlayerShip)
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						(objGetProperty (objGetObjByID (msnGetData gSource 'baseID)) 'abandoned)
						(= (msnGetData gSource 'status) 'foundItems)
						(msnGetProperty gSource 'isActive)
						)
						(msnFailure gSource 'lostItems)
					)
			</OnObjDocked>

			<OnObjDestroyed>
				(switch
					; Target freigher
					(= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(switch
							; Fail if the ship escapes
							(= aDestroyReason 'enteredStargate)
								(msnFailure gSource 'escaped)

							; Fail if there is no wreck
							(not aWreckObj)
								(msnFailure gSource 'destroyed)

							; Otherwise proceed
							(block (theItem)
								; Add the cadaver after destruction (incase player has jettison hack)
								(setq theItem (itmSetData (itmCreate &itHumanCadaver; 1) "corpBioSec" True))
								(objAddItem aWreckObj theItem)
								(msnSetData gSource 'item2 theItem)

								(msnSetData gSource 'wreckID (objGetID aWreckObj))
								(msnSetData gSource 'status 'search)
								(msnSetPlayerTarget gSource)
								(msnAddRecurringTimerEvent gSource 30 'OnCheckItem)
								)
							)

					; Fail if wreck destroyed before player recovers the items
					(and (= (objGetID aObjDestroyed) (msnGetData gSource 'wreckID))
						(!=  (msnGetData gSource 'status) 'foundItems))
						(block Nil
							(msnCancelTimerEvent gSource 'OnCheckItem)
							(msnFailure gSource 'destroyed)
							)

					; Update player target after station is destroyed
					(= (objGetID aObjDestroyed) (msnGetData gSource 'baseID))
						(msnSetPlayerTarget gSource)
					)
			</OnObjDestroyed>

			<OnCheckItem>
				(switch
					(and
						(objHasItem gPlayerShip (msnGetData gSource 'item1))
						(objHasItem gPlayerShip (msnGetData gSource 'item2))
						)
						(block Nil
							(msnSetData gSource 'status 'foundItems)
							(msnSetPlayerTarget gSource)
							(msnCancelTimerEvent gSource 'OnCheckItem)
							)
					)
			</OnCheckItem>

			<OnCompleted>
				(corpBioSec_missionCompleted gSource aReason gData)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnGetNextScreen>
				(msnFireEvent (objGetObjByID (msnGetData gSource 'parentID)) 'OnSubGetNextScreen)
			</OnGetNextScreen>
		</Events>
		<Language>
			<Text id="Name">
				"Obtain Samples"
			</Text>
			<Text id="Summary">
				(corpPriv_calcSummary gSource
					(cat
						"An independent merchant visited " (msnGetData gSource 'stationName) " before the contagion was detected. "
						"Your mission is to track it down and obtain samples. Forcibly."
						)
					)
			</Text>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(list
					{
						desc:	(cat
							"\"We have tracked down an independent merchant ship which visited the station "
							"shortly before the first patients fell ill. Given the limited information we have at "
							"the moment, they are our best lead and could even be source of the infection or "
							"attack.\"\n\n"

							"\"Your mission is collect biological samples and flight data from the ship and any "
							"station they have docked at.\""
							)
						acceptLabel: "\"[I]'m ready.\""
						declineLabel: "\"[L]et me arm up first.\""
						}
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"\"Great! We'll program the target into your ship's computer. It's unlikely the merchant "
					"captain will cooperate; however, we do not require live samples.\""
					)
			</Text>
			<Text id="DeclineReply">
				(cat
					(random (list
						"\"Did you miss the part where a major Corporate station was placed under quarantine?\""
						"\"Have you forgotten about the emergency medical situation?\""
						))
					"\n\n\"Hurry up!\""
					)
			</Text>
			<Text id="InProgress">
				"\"What's wrong? You said you could handle this mission! Get back out there and finish the job!\""
			</Text>
			<Text id="SuccessDebrief">
				(cat
					"\"Nice work out there. Our initial analysis of the data indicates that the merchant ship was unconnected "
					"with the outbreak, but that is still useful information on how the contagion spread.\"\n\n"
					"\"We've deposited " (msnGetData gSource 'reward) " credits to your account.\""
					)
			</Text>
			<Text id="FailureDebrief">
				"\"What the kack happened out there? Now someone else will have to clean up your mess.\""
			</Text>
		</Language>
	</MissionType>

	<ShipTable unid="&tbCorpBioSecInvestigate1Ship;">
		<LevelTable>
			<Ship levelFrequency="ccu-- -----" count="1" class="&scT31ArmedTransport;" orders="hold">
				<Escorts>
					<LevelTable count="3">
						<Ship levelFrequency="ccurr -----" class="&scZulu;" orders="escort"/>
						<Ship levelFrequency="uccur -----" class="&scZulu-II;" orders="escort"/>
					</LevelTable>
				</Escorts>
			</Ship>
			<Ship levelFrequency="-uccu r----" count="1" class="&scT55ArmedTransport;" orders="hold">
				<Escorts>
					<LevelTable count="3">
						<Ship levelFrequency="ucccu rr---" class="&scZulu-II;" orders="escort"/>
						<Ship levelFrequency="vuccc urr--" class="&scOromo;" orders="escort"/>
					</LevelTable>
				</Escorts>
			</Ship>
		</LevelTable>
	</ShipTable>


	<!-- Mission: Intercept Freighter =================================================

	Intercept and stop a freigher from leaving system. Player is allowed to destroy the freighter,
	but will be awarded a bonus if they persuade the freighter to return to base

	EXTRA DATA

	parentID:		Parent mission
	stationID:		objID of quarantined station
	stationName:	Name of quarantined station
	destID:			Destination of ship
	reward:			Reward (in credits) for completing mission
	targetID:		objID of ship to intercept
	shipName:		Name of the ship

	======================================================================== -->

	<MissionType UNID="&msCorpBioSecQuarantine;"
			name=				"Enforce Quarantine"
			attributes=			"corporate, corporatePrivateer, corpBioSec, special"
			priority=			"10"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					destObj targetObj
					)
					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						; Pick a random stargate. It must be a certain distance from us. If we can't
						; find one, then there is no mission.
						(not (setq destObj (random (sysFindObject aOwnerObj "G R:300; -uncharted;"))))
							(msnDestroy gSource)

						; Otherwise, set up mission
						(block Nil
							; Copy data from parent mission
							(msnSetData gSource 'parentID (objGetID aidMission))
							(msnSetData gSource 'stationID (msnGetData aidMission 'stationID))
							(msnSetData gSource 'stationName (msnGetData aidMission 'stationName))

							; Create the freighter
							(setq targetObj (sysCreateShip &tbCorpBioSecQuarantineShip; Nil &svIndependentTrader;))
							(objSetData targetObj 'state 'flee)
							(objSetData targetObj 'destID (objGetID aOwnerObj))

							; And suspend it
							(objSuspend targetObj)

							(msnSetData gSource 'targetID (objGetID targetObj))
							(msnSetData gSource 'shipName (objGetName targetObj 0x05))

							; Remember the destination stargate
							(msnSetData gSource 'destID (objGetID destObj))

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))
							)
						)
					)
			</OnCreate>

			<OnStarted>
				(block (
					(destObj (objGetObjByID (msnGetData gSource 'destID)))
					(distToGate (random 300 600))
					(angleToStation (sysVectorAngle (sysVectorSubtract aOwnerObj destObj)))
					(courseAngle (modulo 'degrees (+ angleToStation (random -60 60)) 360))
					(interceptPos (sysVectorPolarOffset destObj courseAngle distToGate))
					(targetObj (objGetObjByID (msnGetData gSource 'targetID)))
					playerTravelTime freighterDist freighterPos
					)

					; Compute the time that it will take the player to reach the intercept
					; position from the mission station.
					(setq playerTravelTime (sysCalcTravelTime (sysVectorDistance interceptPos aOwnerObj) (shpGetMaxSpeed gPlayerShip)))

					; Adjust travel time a bit because the player won't always travel to the
					; intersection point.
					(setq playerTravelTime (divide (* playerTravelTime 3) 2))

					; Compute the distance that the target freighter will travel in that time
					(setq freighterDist (sysCalcTravelDistance 16 playerTravelTime))

					; Now compute a position for the freighter
					(setq freighterPos (sysVectorPolarOffset destObj courseAngle (+ distToGate freighterDist)))

					; Create the freighter, based on the mission level.
					(objResume targetObj)
					(objSetPos targetObj freighterPos)

					; Register for events so we know when the target is destroyed
					(msnRegisterForEvents gSource targetObj)
					(msnAddRecurringTimerEvent gSource 60 'OnUpdate)
					)
			</OnStarted>

			<OnAccepted>
			</OnAccepted>

			<OnSetPlayerTarget>
				(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)))
			</OnSetPlayerTarget>

			<OnUpdate>
				(block (
					(shipObj (objGetObjByID (msnGetData gSource 'targetID)))
					(armorLeft (- 100 (objGetVisibleDamage shipObj)))
					(shieldLevel (objGetShieldLevel shipObj))
					)
					(switch
						;
						(and (= (objGetData shipObj 'state) 'surrender)
							(gr (objGetDistance shipObj (shpGetOrderTarget shipObj)) 100)
							(gr (objGetDistance shipObj gPlayerShip) 100)
							)
							(objFireEvent shipObj 'OnFlee)

						; Fleeing, no shields, less than 50% armor, and more than (100 + 10*armor) ls from dest
						; and player within range then give up
						(and (= (objGetData shipObj 'state) 'flee)
							(leq shieldLevel 0)
							(leq armorLeft 50)
							(gr (objGetDistance shipObj (shpGetOrderTarget shipObj)) (+ 100 (* 10 armorLeft)))
							(ls (objGetDistance shipObj gPlayerShip) 100)
							)
							(objFireEvent shipObj 'OnSurrender)
						)
					)
			</OnUpdate>

			<OnObjDestroyed>
				(switch
					(= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(msnSuccess gSource 'destroyed)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(switch
					(and
						(= (objGetID aObjDocked) (msnGetData gSource 'targetID))
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						)
						(block Nil
							; Reset soverign and event handler
							(objSetSovereign aObjDocked &svCorporate;)
							(objSetEventHandler aObjDocked (objGetType aObjDocked))
							; Wait for a bit then leave
							(shpOrder aObjDocked 'hold 10)
							(shpOrder aObjDocked 'gate (sysFindObject gSource "GN -uncharted;"))
							; Award a bonus for keeping ship alive
							(msnSetData gSource 'reward (int (* 1.5 (msnGetData gSource 'reward))))
							(msnSuccess gSource 'bonus)
							)
					)
			</OnObjDocked>

			<OnObjEnteredGate>
				(switch
					(= (objGetID aObj) (msnGetData gSource 'targetID))
						(msnFailure gSource)
					)
			</OnObjEnteredGate>

			<OnCompleted>
				(corpBioSec_missionCompleted gSource aReason gData)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnGetNextScreen>
				(msnFireEvent (objGetObjByID (msnGetData gSource 'parentID)) 'OnSubGetNextScreen)
			</OnGetNextScreen>
		</Events>

		<Language>
			<Text id="Name">
				"Enforce Quarantine"
			</Text>
			<Text id="Summary">
				(corpPriv_calcSummary gSource
					(cat
						(strCapitalize (msnGetData gSource 'shipName)) " has evaded the quarantine around "
						(msnGetData gSource 'stationName) ". You must persuade it to return or destroy it."
						)
					)
			</Text>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(list
					{
						desc:	(cat
							"\"" (strCapitalize (msnGetData gSource 'shipName)) " managed to evade the "
							"initial quarantine by leaving the regular shipping routes and hiding in the outer "
							"system. They are now making a run for the stargate.\"\n\n"

							"\"We cannot let them leave until our medics have checked them out. Your job "
							"is to stop them by any means necessary. Understood?\""
							)
						acceptLabel: "\"[I]'m ready.\""
						declineLabel: "\"[L]et me arm up first.\""
						}
					)
			</Text>
			<Text id="AcceptReply">
				"\"Great! We'll program the target into your ship's computer. Remember, you must not let it reach the stargate. Good luck!\""
			</Text>
			<Text id="DeclineReply">
				(cat
					(random (list
						"\"Did you miss the part where a major Corporate station was placed under quarantine?\""
						"\"Have you forgotten about the emergency medical situation?\""
						))
					"\n\n\"Hurry up!\""
					)
			</Text>
			<Text id="InProgress">
				"\"What's wrong? You said you could handle this mission! Get back out there and finish the job!\""
			</Text>
			<Text id="SuccessDebrief">
				(if (= (msnGetData gSource 'outcome) 'bonus)
					(cat
						"\"Great work! The freighter crew is a little shaken up. Luckily for them they turned out to "
						"be clean, but we couldn't risk them breaking quarantine before we were certain.\"\n\n"

						"\"I've been authorized to award you a bonus for keeping them alive. We've deposited "
						(msnGetData gSource 'reward) " credits to your account.\""
						)
					(cat
						"\"Nice work out there! It's a shame we couldn't confirm if the crew were contagious or "
						"not, but we cant take than risk until we understand what is happening here.\"\n\n"

						"\"We've deposited " (msnGetData gSource 'reward) " credits to your account.\""
						)
					)
			</Text>
			<Text id="FailureDebrief">
				(cat
					"\"What the kack happened out there? You just let that ship break quarantine. "
					"Now someone else will have to clean up your mess.\""
					)
			</Text>
		</Language>
	</MissionType>

<!-- TABLES -->

	<ShipTable unid="&tbCorpBioSecQuarantineShip;">
		<LevelTable>
			<Ship levelFrequency="cu--- -----" count="1" class="&scEI100;" orders="gate" eventHandler="&evCorpBioSecQuarantineShip;"/>
			<Ship levelFrequency="ucu-- -----" count="1" class="&scEI200;" orders="gate" eventHandler="&evCorpBioSecQuarantineShip;"/>
			<Ship levelFrequency="-ucu- -----" count="1" class="&scEI500;" orders="gate" eventHandler="&evCorpBioSecQuarantineShip;"/>
			<Ship levelFrequency="--ucc ccccc" count="1" class="&scEI7000;" orders="gate" eventHandler="&evCorpBioSecQuarantineShip;"/>
		</LevelTable>
	</ShipTable>

<!-- BEHAVIORS -->

	<!--	Behavior class for the freighter
		Has to be a ShipClass so the Communications menu will work
		Overrides OnDestroy so player is not accused of piracy
		-->
	<ShipClass UNID="&evCorpBioSecQuarantineShip;" virtual="true" attributes="behaviorClass">
		<Communications>
			<Message name="Cut engines" key="C">
				<OnShow>
					(and	(= (objGetData gSource 'state) 'flee)
						(ls (objGetDistance gSource gPlayerShip) 100)
						)
				</OnShow>
				<Invoke>
					(block (
						(armorLeft (- 100 (objGetVisibleDamage gSource)))
						(shieldLevel (objGetShieldLevel gSource))
						)
						(switch
							; No response if shields up
							(gr shieldLevel 0)
								Nil

							; If we're more than (10 * armor) ls away from gate then give up
							(gr (objGetDistance gSource (shpGetOrderTarget gSource)) (* 10 armorLeft))
								(objFireEvent gSource 'OnSurrender)

							; Otherwise defiant
							(objSendMessage gSender gSource (objTranslate gSource 'defiant))
							)
						)
				</Invoke>
			</Message>
		</Communications>

		<Events>
			<OnSurrender>
				(block Nil
					(objSetData gSource 'state 'surrender)
					(shpCancelOrders gSource)
					(shpOrder gSource 'hold 4)
					(shpOrder gSource 'dock (objGetObjByID (objGetData gSource 'destID)))
					(objSendMessage gSender gSource (objTranslate gSource 'surrender))
					)
			</OnSurrender>

			<OnFlee>
				(block Nil
					(objSetData gSource 'state 'flee)
					(shpCancelOrders gSource)
					(shpOrder gSource 'gate (sysFindObject gSource "GN -uncharted;"))
					)
			</OnFlee>

			<OnDestroy>
			</OnDestroy>

		</Events>

		<Language>
			<Text id="defiant">
				(random
					(list
						"Leave us alone."
						"This is a registered Commonwealth vessel!"
						"You have no right to detain us."
						)
					)
			</Text>
			<Text id="surrender">
				(random
					(list
						"Cease fire! We surrender."
						"OK we're cutting engines."
						"We surrender! Stop firing."
						"We give up. Please don't kill us"
						)
					)
			</Text>
		</Language>
	</ShipClass>


	<!-- Mission: Deliver Supplies =================================================

	When time is running out on the msCorpMedicalAid mission, the player can gain an extra
	ten minutes by delivering some extra medical supplies

	EXTRA DATA

	parentID:		Parent mission
	stationID:		objID of quarantined station
	stationName:	Name of quarantined station
	medsXXXX:		Purchace cost of mes item XXXX
	medsNeeded:		Number of med items required
	destID:			ID of destination (mission owner)
	targetID:		ID of station with supplies
	gotMeds:		True if player has meds
	reward:			Reward for completing mission

	======================================================================== -->

	<MissionType UNID="&msCorpBioSecSupplies1;"
			name=				"Quarantine Investigation 1"
			attributes=			"corporate, corporatePrivateer, corpBioSec, special, deliveryMission"
			priority=			"12"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					stationObj
					)

					; Look for a station that already has Meds
					(setq stationObj (random
						(filter (sysFindObject aOwnerObj "TAF +populated; -occupation; -uncharted;") theDest
							(objGetSellPrice theDest (itmCreate &itMedicalSupplies; 1))
							)
						))

					; Otherwise look for a corporate metropolis.
					; Not using stCorporateMetropolis to avoid dependency on CC library
					(if (not stationObj)
						(setq stationObj (sysFindObject aOwnerObj "TAFN +corporate; +populated; +primary;"))
						)

					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						; Trigger when less than 10 minutes left
						(gr (- (msnGetData aidMission 'expiresOn) (unvGetTick)) 18000)
							(msnDestroy gSource)

						; If we don't have a station then no mission
						(not stationObj)
							(msnDestroy gSource)

						(block (
							; Amount of meds needed depends on level
							(medsNeeded (* (sysGetLevel) 40))
							; We'll accept any standard medical items over level 1
							(medTypes (typFind "i +Meds; -Illegal; -NotForSale; &gt;1"))
							; Check what items the station already has
							(curItems (objGetItems stationObj "tU +Meds; -Illegal; -NotForSale; &gt;1"))
							(curValue (+ (map curItems theItem (* (itmGetLevel theItem) (itmGetCount theItem)))))
							)

							(msnSetData gSource 'parentID (objGetID aidMission))
							; Make sure player has enough time to get the meds
							(msnSetData gSource 'travelTime (* 2 (sysCalcTravelTime (objGetDistance aOwnerObj stationObj) (shpGetMaxSpeed gPlayerShip))))
							(msnIncData aidMission 'expiresOn (msnGetData gSource 'travelTime))

							; Add extra items if needed
							(loop	(ls curValue medsNeeded)
								(block (theItem)
									(setq theItem (itmCreate (random medTypes) 1))
									(objAddItem stationObj theItem (itmGetFrequency theItem))
									(setq curValue (+ curValue (* (itmGetLevel theItem) (itmGetFrequency theItem))))
									)
								)

							; Store cost of Medical items at station
							(enum medTypes theItem
								(msnSetData gSource (cat "med" theItem)
									(objGetSellPrice stationObj (itmCreate theItem 1) 'noInventoryCheck)
									)
								)

							(msnSetData gSource 'medsNeeded medsNeeded)
							(msnSetData gSource 'destID (msnGetProperty gSource 'ownerID))
							(msnSetData gSource 'targetID (objGetID stationObj))
							; Check if we're carrying Meds
							(msnAddRecurringTimerEvent gSource 30 'OnUpdate)

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))
							)
						)
					)
			</OnCreate>

			<OnSetPlayerTarget>
				(if (msnGetData gSource 'gotMeds)
					(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'destID)) 'dock)
					(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)) 'dock)
					)
			</OnSetPlayerTarget>

			<OnUpdate>
				(block (
					(needMeds (not (objGetItems gPlayerShip "tU +Meds; -Illegal; -NotForSale; &gt;1")))
					(aidMission (objGetObjByID (msnGetData gSource 'parentID)))
					)
					(switch
						; If we're out of time, then failure
						(ls (msnGetData aidMission 'expiresOn) (unvGetTick))
							(msnFailure gSource)

						; Update target if needed
						(= needMeds (msnGetData gSource 'gotMeds))
							(block Nil
								(msnSetData gSource 'gotMeds (not needMeds))
								(msnSetPlayerTarget gSource)
								)
						)
					)
			</OnUpdate>

			<OnCompleted>
				(block (
					(aidMission (objGetObjByID (msnGetData gSource 'parentID)))
					)
					; If we succeed then increase time by 10 minutes
					(if (= aReason 'success)
						(msnIncData aidMission 'expiresOn 18000)
						)
					(corpBioSec_missionCompleted gSource aReason gData)
					)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnDeliveryMissionCompleted>
				(block ((meds 0))
					(enum
						(objGetItems gPlayerShip "tU +Meds; -Illegal; -NotForSale; &gt;1")
						medicalItem
						(block Nil
							(objRemoveItem gPlayerShip medicalItem)
							; Reduce the number of meds required
							(msnIncData gSource 'medsNeeded
								(* -1 (itmGetLevel medicalItem) (itmGetCount medicalItem))
								)
							; Calculate how much to reimburse player
							(setq meds (+ meds (*
								(msnGetData gSource (cat "med" (itmGetType medicalItem)))
								(itmGetCount medicalItem)
								)))
							)
						)
					; If we delivered some items then update timer
					(if (gr meds 0)
						(msnIncData
							(objGetObjByID (msnGetData gSource 'parentID))
							'expiresOn
							(msnGetData gSource 'travelTime)
							)
						)
					(plyCredit gPlayer meds)
					(switch
						(= meds 0)
							{	desc: (msnTranslate gSource 'NoMeds)
								forceUndock: True
								}
						(gr (msnGetData gSource 'medsNeeded) 0)
							{	desc: (msnTranslate gSource 'MoreMeds {meds: meds})
								forceUndock: True
								}
						(block Nil
							(msnSuccess gSource)
							(msnReward gSource)
							(msnSetProperty gSource 'isDebriefed True)
							(msnTranslate gSource 'AllMeds {meds: meds})
							)
						)
					)
			</OnDeliveryMissionCompleted>

			<OnGetNextScreen>
				(msnFireEvent (objGetObjByID (msnGetData gSource 'parentID)) 'OnSubGetNextScreen)
			</OnGetNextScreen>
		</Events>

		<Language>
			<Text id="Name">
				"Deliver medical supplies"
			</Text>
			<Text id="Summary">
				(corpPriv_calcSummary gSource
					(cat
						"The " (objGetName (objGetObjByID (msnGetProperty gSource 'ownerID)))
						" is running low on medical supplies. You mission is to acquire more supplies."
						)
					)
			</Text>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(list
					{
						desc:	(cat
								"\"We're running low on medical supplies. We need you to travel to "
								(objGetName (objGetObjByID (msnGetData gSource 'targetID)))
								" and bring back the necessary supplies.\""
								)
						acceptLabel: "\"[I]'m ready.\""
						declineLabel: "\"[L]et me arm up first.\""
						}
					)
			</Text>
			<Text id="AcceptReply">
				"\"Great! Following corporate policy we will reimburse you for the cost of all supplies after delivery.\""
			</Text>
			<Text id="DeclineReply">
				(cat
					"\"We need you to haul cargo, not fight the Ares!\"\n\n"
					"\"Hurry up!\""
					)
			</Text>
			<Text id="FailureDebrief">
				(cat
					"The docking bay is full of exhausted medical technicians and workers "
					"packing up equipment. The dockmaster approaches as you enter.\n\n"

					"\"You're too late&mdash;you better get up to the debriefing.\""
					)
			</Text>
			<Text id="NoMeds">
				"\"What are you doing here? Go get the medicine!\""
			</Text>
			<Text id="MoreMeds">
				(cat
					"\"Thanks, those supplies will help&#x97;but we still need more.\"\n\n"
					"\"We've deposited " (@ gData 'meds) " in your account to cover your costs.\""
					)
			</Text>
			<Text id="AllMeds">
				(cat
					"\"Good work. Those supplies will keep us in operation for the time being.\"\n\n"
					"\"We've reimbursed you for the supplies and deposited " (msnGetData gSource 'reward) " credits for your time.\""
					)
			</Text>
		</Language>
	</MissionType>

	<!-- Mission: Investigate 2 =================================================

	Take ROM to medical station

	EXTRA DATA

	parentID:		Parent mission
	stationID:		objID of quarantined station
	stationName:	Name of quarantined station
	reward:			Reward (in credits) for completing mission

	======================================================================== -->

	<MissionType UNID="&msCorpBioSecInvestigate2;"
			name=				"Quarantine Investigation 2"
			attributes=			"corporate, corporatePrivateer, deliveryMission, corpBioSec, special"
			priority=			"6"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					)
					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						(block (dest email)
							; Copy data from parent mission
							(msnSetData gSource 'parentID (objGetID aidMission))
							(msnSetData gSource 'stationID (msnGetData aidMission 'stationID))
							(msnSetData gSource 'stationName (msnGetData aidMission 'stationName))

							(msnSetData gSource 'srcNodeID (sysGetNode))
							; Find nearest medical station
							(setq dest
								(map
									(unvFindObj "t +commonwealth;")
									'(excludeNil original reduceMin)
									theEntry
									(switch
										; Only want Medical Suburb
										(= (@ theEntry 1) &stMedicalSuburb;)
											(sysGetTopologyDistance (sysGetNode) (@ theEntry 2))
										Nil
										)
									)
								)
							(if (and dest (leq (sysGetTopologyDistance (sysGetNode) (@ dest 2)) 2))
								; Found a nearby station
								(block Nil
									(msnSetData gSource 'destID (@ dest 0))
									(msnSetData gSource 'destNodeID (@ dest 2))
									(msnSetData gSource 'destName (fmtNoun (@ dest 3) (@ dest 4) 1 0x04))
									)
								; Otherwise place one in a random nearby system
								(block Nil
									(msnSetData gSource 'createStation True)
									(msnSetData gSource 'destNodeID (random
										(filter (sysGetNodes) node (= (sysGetTopologyDistance (sysGetNode) node) 1))
										))
									(msnSetData gSource 'destName "a Commonwealth medical colony")
									)
								)

							; Create data ROM for delivery
							(setq email (itmCreate &itNamedDataROM; 1))
							(setq email (itmSetData email "name" "Corporate data ROM"))
							(setq email (itmSetData email "desc" (cat "This heavily encrypted ROM contains medical data from the incident at " (msnGetData gSource 'stationName))))
							(setq email (itmSetData email "corpBioSec" gSource))
							(msnSetData gSource 'dataROM email)

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))

							(msnRegisterForEvents gSource gPlayerShip)
							)
						)
					)
			</OnCreate>

			<OnPlayerEnteredSystem>
				(if	(and
						(msnGetData gSource 'createStation)
						(= (sysGetNode) (msnGetData gSource 'destNodeID))
						)
					(block (destObj)
						(setq destObj (sysCreateStation &stMedicalSuburb;
							(sysVectorRandom Nil (random 160 600) 100 "t -asteroid;")
							))
						(msnSetData gSource 'destID (objGetID destObj))
						(msnSetData gSource 'createStation Nil)

						(msnFireEvent gSource 'OnAddEncounter destObj)
						)
					)
			</OnPlayerEnteredSystem>

			<OnAccepted>
				(block (destObj)
					(objAddItem gPlayerShip (msnGetData gSource 'dataROM))

					(if (= (msnGetData gSource 'destNodeID) (sysGetNode))
						(setq destObj (objGetObjByID (msnGetData gSource 'destID)))
						(setq destObj (sysGetStargateLeadingToNode (msnGetData gSource 'destNodeID)))
						)
					(msnFireEvent gSource 'OnAddEncounter destObj)
					)
			</OnAccepted>

			<OnAddEncounter>
				; Encounter event based on CC msCorpPrivDeliverData
				;
				; gData is the players destination
				(block ((travelTime (sysCalcTravelTime (objGetDistance gPlayerShip gData) (shpGetMaxSpeed gPlayerShip))))

					(if (leq (random 1 100) 80)
						(sysAddEncounterEventAtDist
							(divide (* (random 25 40) travelTime) 100)
							gPlayerShip &tbCorpPrivDataThieves; (random 60 100)
							)
						)

					(if (leq (random 1 100) 40)
						(sysAddEncounterEventAtDist
							(divide (* 50 travelTime) 100)
							gPlayerShip &tbCorpPrivDataThieves; (random 60 100)
							)
						)

					(if (leq (random 1 100) 80)
						(sysAddEncounterEventAtDist
							(divide (* (random 60 75) travelTime) 100)
							gPlayerShip &tbCorpPrivDataThieves; (random 60 100)
							)
						)
					)
			</OnAddEncounter>

			<OnObjDestroyed>
				(switch
					(= aDestroyReason 'enteredStargate)
						Nil

					(= aObjDestroyed gPlayerShip)
						(block Nil
							(objRemoveItem gPlayerShip (msnGetData gSource 'dataROM))
							(msnFailure gSource 'playerKilled)
							)

					(= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(msnFailure gSource 'stationKilled)
					)
			</OnObjDestroyed>

			<OnSetPlayerTarget>
				(switch
					(and (msnGetData gSource 'gotResults) (= (msnGetData gSource 'srcNodeID) (sysGetNode)))
						(rpgSetTarget gSource aReason (objGetObjByID(msnGetProperty gSource 'ownerID)) 'dock)

					(msnGetData gSource 'gotResults)
						(rpgSetTarget gSource aReason (sysGetStargateLeadingToNode (msnGetData gSource 'srcNodeID)))

					(= (msnGetData gSource 'destNodeID) (sysGetNode))
						(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'destID)) 'dock)

					(rpgSetTarget gSource aReason (sysGetStargateLeadingToNode (msnGetData gSource 'destNodeID)))
					)
			</OnSetPlayerTarget>

			<OnDeliveryMissionCompleted>
				(if (objHasItem gPlayerShip (msnGetData gSource 'dataROM))
					(block (
						(destObj (objGetObjByID (msnGetData gSource 'destID)))
						)
						(msnSetData gSource 'gotResults True)
						(msnSetData gSource 'destID Nil)
						(msnSetProperty gSource 'summary (msnTranslate gSource 'Summary))
						(msnSetPlayerTarget gSource)
						(msnTranslate gSource "Delivery:Success" {
							dest: (objGetName destObj 0x04)
							src: (msnGetData (objGetObjByID (msnGetData gSource 'parentID)) 'shipName)
							})
						)
					; If the player doesn't have the dataROM, then the mission fails.
					(block Nil
						(msnFailure gSource 'lostRomOut)
						(msnTranslate gSource "Delivery:Failure")
						)
					)
			</OnDeliveryMissionCompleted>

			<OnObjDocked>
				(switch
					(and	(msnGetProperty gSource 'isActive)
							(msnGetData gSource 'gotResults)
							(= aObjDocked gPlayerShip)
							(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
							(objHasItem gPlayerShip (msnGetData gSource 'dataROM))
						)
						(block Nil
							(objRemoveItem gPlayerShip (msnGetData gSource 'dataROM))
							(msnSuccess gSource)
							)

					; If we've lost the ROM then failure
					(and	(msnGetProperty gSource 'isActive)
							(msnGetData gSource 'gotResults)
							(= aObjDocked gPlayerShip)
							(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						)
						(msnFailure gSource 'lostRomReturn)
					)
			</OnObjDocked>

			<OnCompleted>
				(corpBioSec_missionCompleted gSource aReason gData)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnGetNextScreen>
				(msnFireEvent (objGetObjByID (msnGetData gSource 'parentID)) 'OnSubGetNextScreen)
			</OnGetNextScreen>
		</Events>

		<Language>
			<Text id="Name">
				"Delivery Medical Data"
			</Text>
			<Text id="Summary">
				(corpPriv_calcSummary gSource
					(if (msnGetData gSource 'gotResults)
						(cat
							"Return the medical data ROM to the "
							(msnGetData (objGetObjByID (msnGetData gSource 'parentID)) 'shipName)
							)
						(cat
							"Your mission is to deliver a medical data ROM to " (msnGetData gSource 'destName)
							" in " (sysGetName (msnGetData gSource 'destNodeID))
							)
						)
					)
			</Text>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(list
					{
						desc:	(cat
							"\"We need you to deliver a medical data ROM to " (msnGetData gSource 'destName)
							" in " (sysGetName (msnGetData gSource 'destNodeID)) " for analysis.\""
							)
						acceptLabel: "\"[I]'m ready.\""
						declineLabel: "\"[L]et me arm up first.\""
						}
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"\"Great! We'll program the target into your computer. Good Luck!\""
					)
			</Text>
			<Text id="DeclineReply">
				(cat
					(random (list
						"\"Did you miss the part where a major Corporate station was placed under quarantine?\""
						"\"Have you forgotten about the emergency medical situation?\""
						))
					"\n\n\"Hurry up!\""
					)
			</Text>
			<Text id="InProgress">
				"\"What's wrong? You said you could handle this mission! Get back out there and finish the job!\""
			</Text>
			<Text id="SuccessDebrief">
				(list
					{
						desc: (cat
							"You find a group of senior medical officers waiting when you arrive for debrief. "
							"They take the report from and quickly read through it.\n\n"

							"\"Kack! We were right, the station was targeted with a bioweapon derived from an "
							"old Resurrector neuroplague. However, it was modified to bypass the standard "
							"immunity enhancements used by the Commonwealth.\""
							)
						nextLabel: "\"[Y]ou mean you can't stop it?\""
						}
					{
						desc: (cat
							"\"What? No, don't worry about that, the problem is who...\"\n\n"

							"The operations manager quickly interrupts:\n\n"

							"\"Good work %name%. We've deposited " (msnGetData gSource 'reward)
							" credits to your account.\""
							)
						}
					)
			</Text>
			<Text id="FailureDebrief">
				(block (
					(outcome (msnGetData gSource 'outcome))
					)
					(switch
						(= outcome 'playerKilled)	(msnTranslate gSource "Failure:playerKilled")
						(= outcome 'stationKilled)	(msnTranslate gSource "Failure:stationKilled")
						(= outcome 'lostRomOut)		(msnTranslate gSource "Failure:lostRomOut")
						(= outcome 'lostRomReturn)	(msnTranslate gSource "Failure:lostRomReturn")
						"\"What the kack happened out there? Now someone else will have to clean up your mess.\""
						)
					)
			</Text>
			<Text id="Failure:playerKilled">
				"\"Did you get distracted out there? Oh well, weve already sent someone else to finish the job.\""
			</Text>
			<Text id="Failure:stationKilled">
				(cat
					"\"What the kack happened out there? If you had anything to do with the "
					"destruction of a Commonwealth station there is going to be hell to pay!\""
					)
			</Text>
			<Text id="Failure:lostRomOut">
				"\"What's wrong with you!? Lives are at stake and you failed a simple delivery mission? Get out.\""
			</Text>
			<Text id="Failure:lostRomReturn">
				(cat
					"\"What's wrong with you!? You were supposed to bring the report back here. "
					"Now we've got to send another courier and we can't afford the delay. Get out!\""
					)
			</Text>

			<Text id="Delivery:Success">
				(cat
					"You deliver the medical data ROM to " (@ gData 'dest) " for analysis. "
					"After several hours a medical technician returns the results to you:\n\n"

					"\"You had better get these back to the " (@ gData 'src) " as quickly as possible.\""
					)
			</Text>
			<Text id="Delivery:Failure">
				"\"Where is the data ROM that you were supposed to bring? We cant do anything without it!\""
			</Text>
		</Language>
	</MissionType>

	<!-- Mission: Investigate 3 =================================================

	Investigate Anarchist cell

	EXTRA DATA

	parentID:		Parent mission
	stationID:		objID of quarantined station
	stationName:	Name of quarantined station
	reward:			Reward (in credits) for completing mission
	targetID:		objID of ship to destroy
	item1:			item to recover
	status:			One of:
		'search			Player is outbound
		'return			Player has destroyed target and is returning
		'recoveredROM	Player remembered to collect data ROM

	======================================================================== -->

	<MissionType UNID="&msCorpBioSecInvestigate3;"
			name=				"Quarantine Investigation 3"
			attributes=			"corporate, corporatePrivateer, corpBioSec, special"
			priority=			"6"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					)
					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						; Player must have completed previous mission
						(not (msnFind "r +unid:&msCorpBioSecInvestigate1;;"))
							(msnDestroy gSource)

						(block Nil
							; Copy data from parent mission
							(msnSetData gSource 'parentID (objGetID aidMission))
							(msnSetData gSource 'stationID (msnGetData aidMission 'stationID))
							(msnSetData gSource 'stationName (msnGetData aidMission 'stationName))

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					; Random location 12 to 20 light-minutes from central star.
					(basePos (sysVectorRandom Nil (random 720 1200) 200 "t -asteroid;"))
					baseObj email
					)

					; Create the Anarchist station
					(setq baseObj (sysCreateStation &stAnarchistCell; basePos))

					; Add items to recover
					(setq email (itmCreate &itNamedDataROM; 1))
					(setq email (itmSetData email "name" "Anarchist data ROM"))
					(setq email (itmSetData email "desc" "This unmarked ROM is formatted for 2 exabytes of data. Its contents are heavily encrypted."))
					(setq email (itmSetData email "corpBioSec" True))
					(objAddItem baseObj email)

					; Remember it
					(msnSetData gSource 'targetID (objGetID baseObj))
					(msnSetData gSource 'item1 email)

					; Register for events so we know when the target is destroyed
					(msnRegisterForEvents gSource baseObj)
					(msnRegisterForEvents gSource gPlayerShip)
					(msnSetData gSource 'status 'search)
					)
			</OnAccepted>

			<OnSetPlayerTarget>
				(block (
					(status (msnGetData gSource 'status))
					)
					(switch
						(= status 'search)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)))

						(rpgSetTarget gSource aReason (objGetObjByID (msnGetProperty gSource 'ownerID)))
						)
					)
			</OnSetPlayerTarget>

			<OnObjDestroyed>
				(if (= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
					(block Nil
						(msnSetData gSource 'status 'return)
						(msnSetPlayerTarget gSource)
						)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(switch
					(and (= (msnGetData gSource 'status) 'return)
						(= aObjDocked gPlayerShip)
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						)
						(if (objHasItem gPlayerShip (msnGetData gSource 'item1))
							(block Nil
								(objRemoveItem gPlayerShip (msnGetData gSource 'item1))
								(msnSetData gSource 'status 'recoveredROM)
								(msnSetData gSource 'reward (int (* 1.5 (msnGetData gSource 'reward))))
								(msnSuccess gSource 'bonus)
								)
							(msnSuccess gSource)
							)
					)
			</OnObjDocked>

			<OnCompleted>
				(corpBioSec_missionCompleted gSource aReason gData)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnGetNextScreen>
				(msnFireEvent (objGetObjByID (msnGetData gSource 'parentID)) 'OnSubGetNextScreen)
			</OnGetNextScreen>
		</Events>
		<Language>
			<Text id="Name">
				"Destroy Anarchist Settlement"
			</Text>
			<Text id="Summary">
				(corpPriv_calcSummary gSource
					(cat
						"Your mission is to destroy an Anarchist settlement at the edge of the system."
						)
					)
			</Text>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(list
					{
						desc:	(cat
							"\"We finally have some more intelligence on the biological attack on "
							(msnGetData gSource 'stationName) ". We have traced it back to an "
							"Anarchist cell in the outer system. We want you to go out there and "
							"verify the intelligence&#x97;after you've destroyed anything that moves of course!\""
							)
						acceptLabel: "\"[I]'m ready.\""
						declineLabel: "\"[L]et me arm up first.\""
						}
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"\"Great! We'll program the target into your ship's computer.\"\n\n"

					"\"Don't forget to search the station for any information about the "
					"weapon they used or their future plans. Good luck!\""
					)
			</Text>
			<Text id="DeclineReply">
				(cat
					(random (list
						"\"Did you miss the part where a major Corporate station was placed under quarantine?\""
						"\"Have you forgotten about the emergency medical situation?\""
						))
					"\n\n\"Hurry up!\""
					)
			</Text>
			<Text id="InProgress">
				"\"What's wrong? You said you could handle this mission! Get back out there and finish the job!\""
			</Text>
			<Text id="SuccessDebrief">
				(cat
					(if (= (msnGetData gSource 'status) 'recoveredROM)
						(msnTranslate gSource "SuccessDebrief:FoundROM")
						(msnTranslate gSource "SuccessDebrief:NoROM")
						)
					"\n\n\"We've deposited " (msnGetData gSource 'reward) " credits to your account.\""
					)
			</Text>
			<Text id="SuccessDebrief:NoROM">
				(cat
					"\"You didn't find anything? I was certain there would some clue about the attack at that station.\"\n\n"
					"\"Oh well, at least we have one less band of anarchists out there. No doubt they would have caused trouble if we had let them live.\""
					)
			</Text>
			<Text id="SuccessDebrief:FoundROM">
				(cat
					"\"Great work! The data ROM you found was heavily encrypted, but we'll crack it eventually. "
					"It looks like it contains some references to Tao Station, which is one of their main bases in "
					"Commonwealth space, so with a bit of luck we'll soon have a few more targets for you to torch.\""
					)
			</Text>
			<Text id="FailureDebrief">
				(cat
					"\"What the kack happened out there? Now someone else will have to clean up your mess.\""
					)
			</Text>
		</Language>
	</MissionType>


	<!-- Mission: Inspection =================================================

	Commonwealth medics arrive to inspect the situation. Player is offered
	a bribe to fail this mission.

	EXTRA DATA

	parentID:				Parent mission
	stationID:				objID of quarantined station
	stationName:			Name of quarantined station
	reward:					Reward (in credits) for completing mission
	destID:					The objID of the meeting location (gate, station, marker)
	createdMarker:			True of destID is a marker we should delete afterwards
	shipID:					The objID of the freighter
	shipName:				The name of the freighter
	playerDestroyedShip:	Player destroyed the freighter
	state:					One of the following:
		Nil						Mission not yet started
		'meet					Player must meet the freighter
		'escort					Player must escort the freighter
		'medsDelivered			Freighter delivered supplies
		'medsMissing			Freighter docked, but supplies missing (no response implemented)
		'playerDelivered		Player delivered meds
		'medsRecovered			Meds still on wreck
		'medsLost				Meds gone from wreck
		'shipLost				Freighter destroyed and no wreck
	======================================================================== -->

	<MissionType UNID="&msCorpBioSecInspection;"
			name=				"Quarantine Inspection"
			attributes=			"corporate, corporatePrivateer, corpBioSec, special"
			priority=			"4"
			level=				"1-5"
			maxAppearing=		"1"
			>

		<Events>
			<OnCreate>
				(block (
					(aidMission (@ (msnFind "a +unid:&msCorpMedicalAid;") 0))
					)
					(switch
						; Main mission must be active
						(or (not aidMission) (msnGetProperty aidMission 'isCompleted))
							(msnDestroy gSource)

						(block (destObj shipObj medItem)
							; Copy data from parent mission
							(msnSetData gSource 'parentID (objGetID aidMission))
							(msnSetData gSource 'stationID (msnGetData aidMission 'stationID))
							(msnSetData gSource 'stationName (msnGetData aidMission 'stationName))

							; Search for a suitable location
							(setq destObj (random (or
								; First choice is a gate
								(sysFindObject aOwnerObj "GR:300; -uncharted;")
								; Otherwise try for a major commonwealth station
								(sysFindObject aOwnerObj "TAFR:300; +commonwealth; +majorStation;")
								; Or any friendly station
								(sysFindObject aOwnerObj "TAFR:300;")
								)))

							; Or create a rendezvous in empty space
							(if (not destObj)
								(block Nil
									(setq destObj (sysCreateMarker
										"Rendezvous"
										(sysVectorRandom aOwnerObj (random 600 800) 200 "TA")
										&svCorporate;)
										)
									(msnSetData gSource 'createdMarker)
									)
								)
							(msnSetData gSource 'destID (objGetID destObj))

							(setq medItem (itmSetData (itmCreate &itCyanavir; 10) "CorpBioSec" gSource))
							(msnSetData gSource 'supplies medItem)
							(setq shipObj (sysCreateShip &scEI200; Nil &svCommonwealth;))
							(objAddItem shipObj medItem)
							(objSuspend shipObj)
							(msnSetData gSource 'shipID (objGetID shipObj))
							(msnSetData gSource 'shipName (objGetName shipObj 0x04))

							; Compute reward
							(msnSetData gSource 'reward (corpPriv_calcReward (sysGetLevel)))
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					(destObj (objGetObjByID (msnGetData gSource 'destID)))
					(travelTime (sysCalcTravelTime (objGetDistance gPlayerShip destObj) (shpGetMaxSpeed gPlayerShip)))
					(shipObj (objGetObjByID (msnGetData gSource 'shipID)))
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					)
					(switch
						(objMatches destObj Nil "G")
							(msnAddTimerEvent gSource (+ travelTime 300) "OnFreighterArrives")

						(objMatches destObj Nil "T")
							(block Nil
								(objResume shipObj)
								(objSetPos shipObj destObj)
								(shpOrder shipObj 'dock destObj)
								(shpOrder shipObj 'waitForTarget gPlayership)
								(shpOrder shipObj 'wait 10)
								(shpOrder shipObj 'fireEvent gSource 'OnPlayerArrived)
								(shpOrder shipObj 'fireEvent gSource 'AttackTransport)
								(shpOrder shipObj 'dock stationObj)
								(shpOrder shipObj 'wait 30)
								(shpOrder shipObj 'gate)
								)
						)
					(msnSetData gSource 'state 'meet)
					(msnRegisterForEvents gSource shipObj)
					(msnRegisterForEvents gSource gPlayerShip)

					; Player attacked on way out
					(sysAddEncounterEventAtDist
						(divide (* 50 travelTime) 100)
						gPlayerShip &tbCorpPrivDataThieves; (random 60 100)
						)
					)
			</OnAccepted>

			<OnFreighterArrives>
				(block (
					(destObj (objGetObjByID (msnGetData gSource 'destID)))
					(shipObj (objGetObjByID (msnGetData gSource 'shipID)))
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					)
					(plyMessage gPlayer "Transport arrived!")

					(objResume shipObj destObj)
					(shpOrder shipObj 'dock stationObj)
					(shpOrder shipObj 'wait 30)
					(shpOrder shipObj 'gate)
					(msnSetData gSource 'state 'escort)
					(msnSetPlayerTarget gSource)
					(msnFireEvent gSource 'AttackTransport)
					)
			</OnFreighterArrives>

			<OnPlayerArrived>
				(block Nil
					(msnSetData gSource 'state 'escort)
					(msnSetPlayerTarget gSource)
					)
			</OnPlayerArrived>

			<AttackTransport>
				(block (
					(shipObj (objGetObjByID (msnGetData gSource 'shipID)))
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					(travelTime (sysCalcTravelTime (objGetDistance shipObj stationObj) (shpGetMaxSpeed shipObj)))
					)
					(sysAddEncounterEventAtDist
						(divide (* (random 25 40) travelTime) 100)
						shipObj &tbCorpPrivDataThieves; (random 60 100)
						)

					(if (leq (random 1 100) 40)
						(sysAddEncounterEventAtDist
							(divide (* 50 travelTime) 100)
							shipObj &tbCorpPrivDataThieves; (random 60 100)
							)
						)

					(sysAddEncounterEventAtDist
						(divide (* (random 60 75) travelTime) 100)
						shipObj &tbCorpPrivDataThieves; (random 60 100)
						)
					)
			</AttackTransport>

			<OnSetPlayerTarget>
				(block (
					(state (msnGetData gSource 'state))
					)
					(switch
						(= state 'meet)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'destID)) 'dock)

						(= state 'escort)
							(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'shipID)) 'escort)

						(rpgSetTarget gSource aReason (objGetObjByID (msnGetProperty gSource 'ownerID)) 'dock)
						)
					)
			</OnSetPlayerTarget>

			<OnObjDestroyed>
				(switch
					; If the ship dies, mission fails
					(= (objGetID aObjDestroyed) (msnGetData gSource 'shipID))
						(block (
							(bribe (* (msnGetData gSource 'reward) 10))
							)
							(msnSetData gSource 'playerDestroyedShip (and gPlayerShip (= aOrderGiver gPlayerShip)))
							(objSendMessage gSource Nil (cat bribe " credits deposited to your account."))
							(rpgMissionRewardPayment bribe)
							(msnFailure gSource)
							; If there was a wreck then remember it.
							(if aWreckObj (msnSetData gSource 'wreckID (objGetID aWreckObj)))
							)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(switch
					(and
						(= (objGetID aObjDocked) (msnGetData gSource 'shipID))
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						)
						(block (
							(medsNeeded (msnGetData gSource 'supplies))
							)
							(if (objHasItem aObjDocked medsNeeded)
								(msnSetData gSource 'state 'medsDelivered)
								(msnSetData gSource 'state 'medsMissing)
								)
							(objRemoveItem aObjDocked medsNeeded)
							(msnSuccess gSource)
							)

					; Check if the player has the supplies
					(and
						(= aObjDocked gPlayerShip)
						(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
						(msnGetProperty gSource 'isFailure)
						)
						(block (
							(medsNeeded (msnGetData gSource 'supplies))
							)
							(switch
								(objHasItem gPlayerShip (msnGetData gSource 'supplies))
									(block Nil
										(objRemoveItem aObjDocked (msnGetData gSource 'supplies))
										(msnSetData gSource 'state 'playerDelivered)
										)
								(and (msnGetData gSource 'wreckID) (objGetObjByID (msnGetData gSource 'wreckID)))
									(block (
										(wreckObj (objGetObjByID (msnGetData gSource 'wreckID)))
										)
										(if (objHasItem wreckObj (msnGetData gSource 'supplies))
											(msnSetData gSource 'state 'medsRecovered)
											(msnSetData gSource 'state 'medsLost)
											)
										(objRemoveItem wreckObj (msnGetData gSource 'supplies))
										)
								(msnSetData gSource 'state 'shipLost)
								)
							)
					)
			</OnObjDocked>

			<OnCompleted>
				(corpBioSec_missionCompleted gSource aReason gData)
			</OnCompleted>

			<OnReward>
				(corpPriv_giveReward gSource (msnGetData gSource 'reward))
			</OnReward>

			<OnGetNextScreen>
				(switch
					(= aScreenType 'AcceptFollowUp)
						{	nextScreen: &dsRPGMessage;
							nextScreenData: (msnTranslate gSource "AcceptFollowUp")
							}

					(= aScreenType 'SuccessFollowUp)
						(block Nil
							(msnSuccess (objGetObjByID (msnGetData gSource 'parentID)))
							Nil
							)

					(= aScreenType 'FailureFollowUp)
						(block (
							(state (msnGetData gSource 'state))
							)
							(switch
								(= state 'playerDelivered)
									(msnSuccess (objGetObjByID (msnGetData gSource 'parentID)))

								(= state 'medsRecovered)
									(msnSuccess (objGetObjByID (msnGetData gSource 'parentID)))

								(msnFailure (objGetObjByID (msnGetData gSource 'parentID)))
								)
							Nil
							)
					)
			</OnGetNextScreen>
		</Events>
		<Language>
			<Text id="Intro">
				(corpBioSec_calcIntro)
			</Text>
			<Text id="Briefing">
				(cat
					"\"A team from Commonwealth Medical is on their way to provide deliver and "
					"review the situation here. Your mission is to meet with them and escort them "
					"back to the " (msnGetData (objGetObjByID (msnGetData gSource 'parentID)) 'shipName)
					". We'll pay you " (msnGetData gSource 'reward) " credits.\""
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"\"Great! They'll be travelling on " (msnGetData gSource 'shipName) ". "
					"We'll program the rendezvous into your ship's computer. Good luck!\""
					)
			</Text>
			<Text id="AcceptFollowUp">
				{	desc: (cat
						"As you are leaving the briefing an agent you don't recognize approaches you.\n\n"

						"\"Greetings %name%, you are no doubt aware that the situation on the "
						"station is highly sensitive and we cannot allow any interference with "
						"internal Corporate operations at this time. There will be a bonus of "
						"ten times your usual rate if the Commonwealth team fails to arrive.\""
						)
					nextScreen: 'forceUndock
					}
			</Text>
			<Text id="DeclineReply">
				"\"Why are you here then? Stop wasting our time...\""
			</Text>
			<Text id="SuccessDebrief">
				(list
					{	desc: (cat
							"The docking bay swarms with activity. Commonwealth and Corporate medical "
							"technicians mix freely and discuss the treatment program. A few of the "
							"CHOC agents look uneasy at the large number of non-Corporate personnel "
							"on board. As you head to debriefing you think someone is watching you, "
							"but you see no one when you look around."
						)}
					{	desc: (cat
							"\"Good work %name%. " (msnGetData gSource 'shipName) " brought a fresh "
							"supply of cyanavir which we are modifying to target the neuroplague. "
							"We'll be able to lift the quarantine as soon as everyone has received treatment.\"\n\n"

							"\"We've deposited " (msnGetData gSource 'reward) " credits to your account.\""
						)}
					)
			</Text>
			<Text id="FailureDebrief">
				(if (msnGetData gSource 'playerDestroyedShip)
					(msnTranslate gSource "FailureDebriefBetrayal")
					(msnTranslate gSource "FailureDebriefStandard")
					)
			</Text>
			<Text id="FailureDebriefBetrayal">
				(cat
					"\"What the kack happened out there? That was a Commonwealth Medical "
					"transport you hit out there. If the Commonwealth finds out what happened "
					"you'll be in a lot of trouble&mdash;don't expect any help from us!\"\n\n"
					(switch
						(= (msnGetData gSource 'state) 'playerDelivered)
							"\"At least you recovered the supplies. With those well be able to treat the remaining patients and lift the quarantine.\""

						(= (msnGetData gSource 'state) 'medsRecovered)
							"\"At least we managed to recover the supplies from the wreck. With those well be able to treat the remaining patients and lift the quarantine.\""

						"\"Without the supplies the remaining patients won't survive and that is on you. We won't require your assistance any longer.\""
						)
					"\n\nYou check your account and find an anonymous payment of "
					(* (msnGetData gSource 'reward) 10) " credits."
					)
			</Text>
			<Text id="FailureDebriefStandard">
				(cat
					"\"What happened out there? The Commonwealth authorities are going to furious when "
					"they hear " (msnGetData gSource 'shipName) " was lost while under our protection.\"\n\n"
					(switch
						(= (msnGetData gSource 'state) 'playerDelivered)
							"\"At least you recovered the supplies. With those well be able to treat the remaining patients and lift the quarantine.\""

						(= (msnGetData gSource 'state) 'medsRecovered)
							"\"At least we managed to recover the supplies from the wreck. With those well be able to treat the remaining patients and lift the quarantine.\""

						"\"Without the supplies the remaining patients won't survive. You are dismissed.\""
						)
					"\n\nYou check your account and find an anonymous payment of "
					(* (msnGetData gSource 'reward) 10) " credits."
					)
			</Text>
		</Language>
	</MissionType>

</TranscendenceModule>
